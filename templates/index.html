<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Two Friends Chat with Live Preview</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding-bottom: 70px;
    background: #f5f5f5;
  }
  #chat-box {
    padding: 10px;
    overflow-y: auto;
    height: calc(100vh - 70px);
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
  }
  .message {
    max-width: 60%;
    padding: 8px 12px;
    margin: 5px;
    border-radius: 10px;
    word-wrap: break-word;
    line-height: 1.3;
    font-size: 16px;
  }
  .sender {
    background: #d1e7ff;
    align-self: flex-end;
    text-align: right;
  }
  .receiver {
    background: #c1f7d1;
    align-self: flex-start;
    text-align: left;
  }
  .preview {
    opacity: 0.6;
    font-style: italic;
  }

  /* Fixed bottom input area */
  #input-area {
    position: fixed;
    bottom: 0; left: 0;
    width: 100%;
    background: white;
    padding: 8px;
    display: flex;
    gap: 6px;
    box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
    z-index: 10;
  }

  /* Small dropdown */
  #sender {
    padding: 6px;
    font-size: 13px;
    border-radius: 6px;
    border: 1px solid #ccc;
    background: #f9f9f9;
    flex: 0 0 80px;
  }

  /* Modern input */
  #message {
    flex: 1;
    padding: 10px 14px;
    font-size: 15px;
    border-radius: 20px;
    border: 1px solid #ccc;
    background: #f5f5f5;
    outline: none;
    transition: border 0.2s, background 0.2s;
  }
  #message:focus {
    border-color: #0084ff;
    background: white;
  }

  /* Modern send button */
  #send-btn {
    background: #0084ff;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.2s;
  }
  #send-btn:hover {
    background: #006fd6;
  }
</style>
</head>
<body>

<div id="chat-box"></div>

<div id="input-area">
  <select id="sender">
    <option value="friend1">Friend 1</option>
    <option value="friend2">Friend 2</option>
  </select>
  <input type="text" id="message" placeholder="Type a message..." autocomplete="off"/>
  <button id="send-btn">Send</button>
</div>

<!-- Socket.IO client -->
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
  const room_id = window.location.pathname.split("/").pop();
  const socket = io();
  let currentUser = document.getElementById("sender").value;

  function register() {
    currentUser = document.getElementById("sender").value;
    socket.emit('register', { username: currentUser, room_id: room_id });
    document.getElementById("message").value = "";
    renderChat([]);
  }

  let messages = [];
  let currentPreview = "";

  function renderChat(extraMsgs=[]) {
    const chatBox = document.getElementById("chat-box");
    chatBox.innerHTML = "";
    const all = messages.concat(extraMsgs);
    all.sort((a,b) => a.timestamp - b.timestamp);

    all.forEach(msg => {
      const div = document.createElement("div");
      div.classList.add("message");
      if(msg.sender === currentUser) {
        div.classList.add("sender");
      } else {
        div.classList.add("receiver");
      }
      div.textContent = msg.text;
      chatBox.appendChild(div);
    });

    const otherUser = currentUser === "friend1" ? "friend2" : "friend1";
    if(currentPreview && currentPreview.trim() !== "") {
      const previewDiv = document.createElement("div");
      previewDiv.classList.add("message", "receiver", "preview");
      previewDiv.textContent = currentPreview;
      chatBox.appendChild(previewDiv);
    }

    chatBox.scrollTop = chatBox.scrollHeight;
  }

  socket.on('history', (data) => {
    messages = data || [];
    renderChat();
  });

  socket.on('new_message', (msg) => {
    messages.push(msg);
    renderChat();
  });

  socket.on('preview', (data) => {
    const from = data.from;
    const text = data.text || "";
    const otherUser = currentUser === "friend1" ? "friend2" : "friend1";
    if(from === otherUser) {
      currentPreview = text;
      renderChat();
    }
  });

  function sendMessage() {
    const sender = currentUser;
    const receiver = sender === "friend1" ? "friend2" : "friend1";
    const text = document.getElementById("message").value.trim();
    if (!text) return;
    socket.emit('send_message', { sender, receiver, text, room_id: room_id });
    document.getElementById("message").value = "";
    socket.emit('typing', { sender, receiver, text: '', room_id: room_id });
  }

  function previewMessage() {
    const sender = currentUser;
    const receiver = sender === "friend1" ? "friend2" : "friend1";
    const text = document.getElementById("message").value;
    socket.emit('typing', { sender, receiver, text, room_id: room_id });
  }

  document.getElementById("send-btn").addEventListener("click", sendMessage);
  document.getElementById("message").addEventListener("input", previewMessage);
  document.getElementById("message").addEventListener("keydown", e => {
    if(e.key === "Enter") {
      e.preventDefault();
      sendMessage();
    }
  });
  document.getElementById("sender").addEventListener("change", register);

  window.addEventListener('load', register);

  // Mobile keyboard वर input वर नेण्यासाठी
  const inputArea = document.getElementById("input-area");
  const messageInput = document.getElementById("message");
  messageInput.addEventListener("focus", () => {
    setTimeout(() => {
      inputArea.scrollIntoView({ behavior: "smooth", block: "end" });
    }, 300);
  });
</script>

</body>
</html>
