<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Two Friends Chat with Live Preview</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding-bottom: 70px;
    background: #f5f5f5;
    transition: background 0.3s, color 0.3s;
  }
  body.dark {
    background: #121212;
    color: white;
  }
  #chat-box {
    padding: 10px;
    overflow-y: auto;
    height: calc(100vh - 70px);
    display: flex;
    flex-direction: column-reverse; /* ‡§®‡§µ‡•Ä‡§® ‡§Æ‡•á‡§∏‡•á‡§ú ‡§ñ‡§æ‡§≤‡•Ä */
  }
  .message {
    max-width: 60%;
    padding: 8px 12px;
    margin: 5px;
    border-radius: 10px;
    word-wrap: break-word;
    line-height: 1.3;
    font-size: 16px;
  }
  .sender {
    background: #d1e7ff;
    align-self: flex-end;
    text-align: right;
  }
  .receiver {
    background: #c1f7d1;
    align-self: flex-start;
    text-align: left;
  }
  body.dark .sender {
    background: #2e4a66;
  }
  body.dark .receiver {
    background: #1d4d2e;
  }
  .preview {
    opacity: 0.6;
    font-style: italic;
  }
  /* Fixed bottom input area */
  #input-area {
    position: fixed;
    bottom: 0; left: 0;
    width: 100%;
    background: white;
    padding: 8px;
    display: flex;
    gap: 6px;
    box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
    z-index: 10;
  }
  body.dark #input-area {
    background: #1e1e1e;
  }
  #sender {
    padding: 6px;
    font-size: 13px;
    border-radius: 6px;
    border: 1px solid #ccc;
    background: #f9f9f9;
    flex: 0 0 80px;
  }
  body.dark #sender {
    background: #333;
    color: white;
    border: 1px solid #555;
  }
  #message {
    flex: 1;
    padding: 10px 14px;
    font-size: 15px;
    border-radius: 20px;
    border: 1px solid #ccc;
    background: #f5f5f5;
    outline: none;
    transition: border 0.2s, background 0.2s;
  }
  body.dark #message {
    background: #2a2a2a;
    color: white;
    border: 1px solid #555;
  }
  #message:focus {
    border-color: #32e812;
    background: white;
  }
  body.dark #message:focus {
    background: #333;
  }
  #send-btn {
    background: #1d5426;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.2s;
    margin-right: 20px; /* ‡§â‡§ú‡§µ‡•Ä‡§ï‡§°‡•á ‡§Æ‡§æ‡§∞‡•ç‡§ú‡§ø‡§® */
  }
  #send-btn:hover {
    background: #056c29;
  }
  /* Dark mode toggle */
  #dark-toggle {
    position: fixed;
    top: 10px;
    right: 10px;
    padding: 6px 12px;
    border-radius: 20px;
    border: none;
    cursor: pointer;
    background: #444;
    color: white;
    font-size: 14px;
  }
</style>
</head>
<body>

<button id="dark-toggle">üåô Dark Mode</button>
<div id="chat-box"></div>

<div id="input-area">
  <select id="sender">
    <option value="friend1">Friend 1</option>
    <option value="friend2">Friend 2</option>
  </select>
  <input type="text" id="message" placeholder="Type a message..." autocomplete="off"/>
  <button id="send-btn">Send</button>
</div>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
  const room_id = window.location.pathname.split("/").pop();
  const socket = io();
  let currentUser = document.getElementById("sender").value;
  let messages = [];
  let currentPreview = "";

  function register() {
    currentUser = document.getElementById("sender").value;
    socket.emit('register', { username: currentUser, room_id: room_id });
    document.getElementById("message").value = "";
    renderChat([]);
  }

  function renderChat(extraMsgs=[]) {
    const chatBox = document.getElementById("chat-box");
    chatBox.innerHTML = "";
    const all = messages.concat(extraMsgs);
    all.sort((a,b) => b.timestamp - a.timestamp); // ‡§®‡§µ‡•Ä‡§® ‡§Æ‡•á‡§∏‡•á‡§ú ‡§ñ‡§æ‡§≤‡•Ä
    all.forEach(msg => {
      const div = document.createElement("div");
      div.classList.add("message");
      if(msg.sender === currentUser) div.classList.add("sender");
      else div.classList.add("receiver");
      div.textContent = msg.text;
      chatBox.appendChild(div);
    });
    if(currentPreview && currentPreview.trim() !== "") {
      const previewDiv = document.createElement("div");
      previewDiv.classList.add("message", "receiver", "preview");
      previewDiv.textContent = currentPreview;
      chatBox.prepend(previewDiv);
    }
  }

  socket.on('history', data => { messages = data || []; renderChat(); });
  socket.on('new_message', msg => { messages.unshift(msg); renderChat(); });
  socket.on('preview', data => {
    const otherUser = currentUser === "friend1" ? "friend2" : "friend1";
    if(data.from === otherUser) { currentPreview = data.text || ""; renderChat(); }
  });

  function sendMessage() {
    const text = document.getElementById("message").value.trim();
    if (!text) return;
    const sender = currentUser;
    const receiver = sender === "friend1" ? "friend2" : "friend1";
    socket.emit('send_message', { sender, receiver, text, room_id });
    document.getElementById("message").value = "";
    socket.emit('typing', { sender, receiver, text: '', room_id });
  }
  function previewMessage() {
    const text = document.getElementById("message").value;
    const sender = currentUser;
    const receiver = sender === "friend1" ? "friend2" : "friend1";
    socket.emit('typing', { sender, receiver, text, room_id });
  }

  document.getElementById("send-btn").addEventListener("click", sendMessage);
  document.getElementById("message").addEventListener("input", previewMessage);
  document.getElementById("message").addEventListener("keydown", e => { if(e.key === "Enter") { e.preventDefault(); sendMessage(); }});
  document.getElementById("sender").addEventListener("change", register);
  window.addEventListener('load', register);

  // Dark mode toggle
  document.getElementById("dark-toggle").addEventListener("click", () => {
    document.body.classList.toggle("dark");
    document.getElementById("dark-toggle").textContent = document.body.classList.contains("dark") ? "‚òÄ Light Mode" : "üåô Dark Mode";
  });
</script>
</body>
</html>
